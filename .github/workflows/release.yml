name: Build Packages

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxfce4panel-2.0-dev libgtk-3-dev libsoup-3.0-dev \
            libjson-glib-dev libsecret-1-dev pkg-config ruby-dev build-essential
          sudo gem install fpm

      - name: Build
        run: |
          make PREFIX=/usr
          make PREFIX=/usr DESTDIR=pkg install

      - name: Build for RPM (lib64)
        run: |
          make clean
          make PREFIX=/usr LIBDIR=/usr/lib64
          make PREFIX=/usr LIBDIR=/usr/lib64 DESTDIR=pkg-rpm install

      - name: Create DEB
        run: |
          fpm -s dir -t deb \
            -n xfce-ask \
            -v ${{ github.ref_name }} \
            -d "xfce4-panel" -d "libgtk-3-0" -d "libsoup-3.0-0" \
            -d "libjson-glib-1.0-0" -d "libsecret-1-0" \
            --description "XFCE panel plugin for OpenAI-compatible chat endpoints" \
            --url "https://github.com/rabfulton/xfce-ask" \
            --license MIT \
            -C pkg .

      - name: Create RPM
        run: |
          fpm -s dir -t rpm \
            -n xfce-ask \
            -v ${{ github.ref_name }} \
            -d "xfce4-panel" -d "gtk3" -d "libsoup3" \
            -d "json-glib" -d "libsecret" \
            --description "XFCE panel plugin for OpenAI-compatible chat endpoints" \
            --url "https://github.com/rabfulton/xfce-ask" \
            --license MIT \
            -C pkg-rpm .

      - name: Test DEB package
        run: |
          docker run --rm -v $PWD:/work debian:bookworm bash -c "
            apt-get update &&
            apt-get install -y /work/*.deb &&
            dpkg -L xfce-ask | grep libopenai-ask.so &&
            echo 'DEB package OK'
          "

      - name: Test RPM package
        run: |
          docker run --rm -v $PWD:/work fedora:latest bash -c "
            dnf install -y /work/*.rpm &&
            rpm -ql xfce-ask | grep libopenai-ask.so &&
            echo 'RPM package OK'
          "

      - name: Upload packages to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.deb
            *.rpm
